{% extends 'core/base.html' %}

{% block title %}Map - LocaFeed{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col">
            <a href="{% url 'dashboard' %}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
            
            {% if center_post %}
                <h2 class="mt-3">{{ center_post.location.name }}</h2>
                <p class="text-muted">Posted by {{ center_post.author.username }} {{ center_post.created_at|timesince }} ago</p>
            {% else %}
                <h2 class="mt-3">Posts Map</h2>
                <p class="text-muted">Explore posts by location</p>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pass Django data to JavaScript -->
<script id="map-data" type="application/json">
{
    "centerPost": {% if center_post %}
        {
            "latitude": {{ center_post.location.latitude|stringformat:"f" }},
            "longitude": {{ center_post.location.longitude|stringformat:"f" }},
            "author": "{{ center_post.author.username|escapejs }}",
            "text": "{{ center_post.text|escapejs }}",
            "time": "{{ center_post.created_at|timesince }} ago"
        }
    {% else %}null{% endif %},
    "posts": [
        {% for post in posts %}
            {% if post.location %}
                {
                    "id": {{ post.id }},
                    "latitude": {{ post.location.latitude|stringformat:"f" }},
                    "longitude": {{ post.location.longitude|stringformat:"f" }},
                    "author": "{{ post.author.username|escapejs }}",
                    "text": "{{ post.text|escapejs }}",
                    "time": "{{ post.created_at|timesince }} ago"
                }{% if not forloop.last %},{% endif %}
            {% endif %}
        {% endfor %}
    ]
}
</script>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Parse the data from the script tag
    var mapDataStr = document.getElementById('map-data').textContent;
    var mapData;
    
    try {
        mapData = JSON.parse(mapDataStr);
    } catch (e) {
        console.error("Error parsing map data:", e);
        mapData = { centerPost: null, posts: [] };
    }
    
    // Initialize map
    var map = L.map('map').setView([0, 0], 2);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Array to store all markers for bounds calculation
    var allMarkers = [];
    
    if (mapData.centerPost) {
        // Single post view
        var marker = L.marker([
            mapData.centerPost.latitude,
            mapData.centerPost.longitude
        ]).addTo(map);
        
        marker.bindPopup(
            '<strong>' + mapData.centerPost.author + '</strong><br>' +
            mapData.centerPost.text + '<br>' +
            '<small class="text-muted">' + mapData.centerPost.time + '</small>'
        ).openPopup();
        
        // Center on this marker
        map.setView([mapData.centerPost.latitude, mapData.centerPost.longitude], 13);
    } else {
        // Add markers for all posts
        mapData.posts.forEach(function(post) {
            var marker = L.marker([post.latitude, post.longitude]).addTo(map);
            
            marker.bindPopup(
                '<strong>' + post.author + '</strong><br>' +
                post.text + '<br>' +
                '<small class="text-muted">' + post.time + '</small><br>' +
                '<a href="/map/' + post.id + '/">View details</a>'
            );
            
            allMarkers.push(marker);
        });
        
        // If we have markers, fit bounds
        if (allMarkers.length > 0) {
            var group = L.featureGroup(allMarkers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }
});
</script>
{% endblock %}
